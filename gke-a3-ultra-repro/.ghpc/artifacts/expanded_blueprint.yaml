# Copyright 2023 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

blueprint_name: gke-a3-ultra
ghpc_version: v1.43.0-4-g14cff51e-dirty
vars:
  a3ultra_node_pool_disk_size_gb: 100
  authorized_cidr: 0.0.0.0/0
  deployment_name: gke-a3-ultra-repro
  extended_reservation: slurm-gcp-a3u-gsc
  gke_min_version: 1.31.3
  labels:
    ghpc_blueprint: gke-a3-ultra
    ghpc_deployment: ((var.deployment_name))
  mtu_size: 8896
  project_id: hpc-toolkit-gsc
  region: europe-west1
  static_node_count: 1
  system_node_pool_disk_size_gb: 200
  zone: europe-west1-b
deployment_groups:
  - group: primary
    terraform_backend:
      type: gcs
      configuration:
        bucket: tas-terraform
        prefix: (("gke-a3-ultra/${var.deployment_name}/primary"))
    terraform_providers:
      google:
        source: hashicorp/google
        version: 6.13.0
        configuration:
          project: ((var.project_id))
          region: ((var.region))
          zone: ((var.zone))
      google-beta:
        source: hashicorp/google-beta
        version: 6.13.0
        configuration:
          project: ((var.project_id))
          region: ((var.region))
          zone: ((var.zone))
    modules:
      - source: github.com/GoogleCloudPlatform/cluster-toolkit.git//modules/network/vpc?ref=e0c690b
        kind: terraform
        id: gke-a3-ultra-net-0
        settings:
          deployment_name: ((var.deployment_name))
          firewall_rules:
            - allow:
                - ports:
                    - 0-65535
                  protocol: tcp
                - ports:
                    - 0-65535
                  protocol: udp
                - protocol: icmp
              name: gke-a3-ultra-internal-0
              ranges:
                - 192.168.0.0/16
          labels: ((var.labels))
          network_name: gke-a3-ultra-net-0
          project_id: ((var.project_id))
          region: ((var.region))
          secondary_ranges:
            gke-a3-ultra-sub-0:
              - ip_cidr_range: 10.4.0.0/14
                range_name: pods
              - ip_cidr_range: 10.0.32.0/20
                range_name: services
          subnetworks:
            - subnet_ip: 192.168.0.0/18
              subnet_name: gke-a3-ultra-sub-0
              subnet_region: ((var.region))
      - source: github.com/GoogleCloudPlatform/cluster-toolkit.git//modules/network/vpc?ref=e0c690b
        kind: terraform
        id: gke-a3-ultra-net-1
        settings:
          deployment_name: ((var.deployment_name))
          firewall_rules:
            - allow:
                - ports:
                    - 0-65535
                  protocol: tcp
                - ports:
                    - 0-65535
                  protocol: udp
                - protocol: icmp
              name: gke-a3-ultra-internal-1
              ranges:
                - 192.168.0.0/16
          labels: ((var.labels))
          mtu: ((var.mtu_size))
          network_name: gke-a3-ultra-net-1
          project_id: ((var.project_id))
          region: ((var.region))
          subnetworks:
            - subnet_ip: 192.168.64.0/18
              subnet_name: gke-a3-ultra-sub-1
              subnet_region: ((var.region))
      - source: github.com/GoogleCloudPlatform/cluster-toolkit.git//community/modules/network/rdma-vpc?ref=98c49fe
        kind: terraform
        id: gke-a3-ultra-rdma-net
        settings:
          deployment_name: ((var.deployment_name))
          mtu: ((var.mtu_size))
          network_name: gke-a3-ultra-rdma-net
          network_profile: (("https://www.googleapis.com/compute/beta/projects/${var.project_id}/global/networkProfiles/${var.zone}-vpc-roce"))
          network_routing_mode: REGIONAL
          project_id: ((var.project_id))
          region: ((var.region))
          subnetworks_template:
            count: 8
            ip_range: 192.168.128.0/18
            name_prefix: gke-a3-ultra-rdma-sub
            region: ((var.region))
      - source: github.com/GoogleCloudPlatform/cluster-toolkit.git//modules/scheduler/gke-cluster?ref=e0c690b
        kind: terraform
        id: a3-ultragpu-cluster
        use:
          - gke-a3-ultra-net-0
        outputs:
          - name: instructions
        settings:
          additional_networks: ((concat([{ network = module.gke-a3-ultra-net-1.network_name, subnetwork = module.gke-a3-ultra-net-1.subnetwork_name, subnetwork_project = var.project_id, nic_type = "GVNIC", queue_count = null, network_ip = null, stack_type = null, access_config = [{ nat_ip = null, public_ptr_domain_name = null, network_tier = null }], ipv6_access_config = [], alias_ip_range = [] }], module.gke-a3-ultra-rdma-net.subnetwork_interfaces_gke)))
          deployment_name: ((var.deployment_name))
          enable_dcgm_monitoring: true
          enable_gcsfuse_csi: true
          enable_private_endpoint: false
          labels: ((var.labels))
          master_authorized_networks:
            - cidr_block: ((var.authorized_cidr))
              display_name: kubectl-access-network
          min_master_version: ((var.gke_min_version))
          network_id: ((module.gke-a3-ultra-net-0.network_id))
          project_id: ((var.project_id))
          region: ((var.region))
          subnetwork_self_link: ((module.gke-a3-ultra-net-0.subnetwork_self_link))
          system_node_pool_disk_size_gb: ((var.system_node_pool_disk_size_gb))
          system_node_pool_machine_type: e2-standard-16
          system_node_pool_taints: []
          zone: ((var.zone))
      - source: github.com/GoogleCloudPlatform/cluster-toolkit.git//modules/compute/gke-node-pool?ref=e0c690b
        kind: terraform
        id: a3-ultragpu-pool
        use:
          - a3-ultragpu-cluster
        outputs:
          - name: instructions
        settings:
          additional_networks: ((concat([{ network = module.gke-a3-ultra-net-1.network_name, subnetwork = module.gke-a3-ultra-net-1.subnetwork_name, subnetwork_project = var.project_id, nic_type = "GVNIC", queue_count = null, network_ip = null, stack_type = null, access_config = [{ nat_ip = null, public_ptr_domain_name = null, network_tier = null }], ipv6_access_config = [], alias_ip_range = [] }], module.gke-a3-ultra-rdma-net.subnetwork_interfaces_gke)))
          cluster_id: ((module.a3-ultragpu-cluster.cluster_id))
          disk_size_gb: ((var.a3ultra_node_pool_disk_size_gb))
          disk_type: hyperdisk-balanced
          gke_version: ((module.a3-ultragpu-cluster.gke_version))
          guest_accelerator:
            - count: 8
              gpu_driver_installation_config:
                gpu_driver_version: LATEST
              type: nvidia-h200-141gb
          internal_ghpc_module_id: a3-ultragpu-pool
          labels: ((var.labels))
          machine_type: a3-ultragpu-8g
          project_id: ((var.project_id))
          reservation_affinity:
            consume_reservation_type: SPECIFIC_RESERVATION
            specific_reservations:
              - name: ((var.extended_reservation))
          static_node_count: ((var.static_node_count))
          zones:
            - ((var.zone))
terraform_backend_defaults:
  type: gcs
  configuration:
    bucket: tas-terraform
terraform_providers:
  google:
    source: hashicorp/google
    version: 6.13.0
    configuration:
      project: ((var.project_id))
      region: ((var.region))
      zone: ((var.zone))
  google-beta:
    source: hashicorp/google-beta
    version: 6.13.0
    configuration:
      project: ((var.project_id))
      region: ((var.region))
      zone: ((var.zone))
